image:
  - Visual Studio 2017

environment:
  RELEASE_BRANCH: master
  RELEASE_REPO: Samsung/netcoredbg
  GITHUB_API_KEY:
    secure: xo2QfdJ8hUxbek9peb3Pi/7cO9aEvg+CHlnmyVNz5szTsg3reQH0YqXKM4oMT3Xh

branches:
  except:
    - latest

build_script:
  ps: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 15 2017 Win64" -DCMAKE_INSTALL_PREFIX="$pwd\..\netcoredbg"
        cmake --build . --config Release --target install
        cd ..
        .dotnet\dotnet.exe build tests

after_build:
  ps: |
        7z a netcoredbg-win64-$env:APPVEYOR_REPO_BRANCH.zip netcoredbg

test_script:
  ps: |
        $env:PIPE = "$pwd\netcoredbg\netcoredbg.exe"
        $env:PATH = "$pwd\.dotnet;$env:PATH"
        dotnet test tests\runner

artifacts:
  - path: '*.zip'
    name: netcoredbg

deploy:
  tag: latest
  description: '[Autogenerated] This is the latest version pushed to the $(APPVEYOR_REPO_BRANCH) branch.'
  provider: GitHub
  auth_token: $(GITHUB_API_KEY)
  artifact: netcoredbg
  draft: false
  prerelease: false
  repository: $(RELEASE_REPO)
  force_update: true
  on:
    branch: $(RELEASE_BRANCH)
